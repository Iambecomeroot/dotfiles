let s:vim_config_dir = has('nvim')
\ ? $XDG_CONFIG_HOME . '/nvim/'
\ : $HOME . '/.vim/'


"
" Plugins
"

if filereadable(s:vim_config_dir . 'autoload/plug.vim')
	call plug#begin(s:vim_config_dir . 'plugged')

		"
		" Additional functionality
		"

		Plug 'tpope/vim-dadbod'
		Plug 'tpope/vim-dotenv'
		Plug 'tpope/vim-commentary'
		Plug 'tpope/vim-ragtag'
		" Helpers for UNIX
		Plug 'tpope/vim-eunuch'

		" tags file management
		Plug 'ludovicchabant/vim-gutentags'

		" Add more targets
		Plug 'wellle/targets.vim'

		" Tree view
		Plug 'scrooloose/nerdtree', { 'on': [ 'NERDTree', 'NERDTreeToggle', 'NERDTreeFind' ] }

		" Better history
		Plug 'mbbill/undotree'

		" Fuzzy file finder
		Plug 'junegunn/fzf', { 'dir': '~/.fzf', 'do': './install --all' }
		Plug 'junegunn/fzf.vim'

		Plug 'wincent/ferret'

		" Enable dot repetition for plugins
		Plug 'tpope/vim-repeat'

		" Surround blocks with characters
		Plug 'tpope/vim-surround'

		" Pairs of handy pairs mappings
		" Good for moving lines and such
		Plug 'tpope/vim-unimpaired'

		" Git
		Plug 'tpope/vim-fugitive'
		Plug 'tpope/vim-rhubarb'
		Plug 'shumphrey/fugitive-gitlab.vim'
		Plug 'airblade/vim-gitgutter'

		" Save session
		Plug 'tpope/vim-obsession'

		" Compare when vim finds a swap file
		Plug 'chrisbra/Recover.vim'

		" Word and case variants
		Plug 'tpope/tpope-vim-abolish'

		Plug 'metakirby5/codi.vim'

		Plug 'rickhowe/diffchar.vim'

		" Vimscript test suite
		Plug 'junegunn/vader.vim'

		"
		" Convenience
		"

		" Open files in last place
		Plug 'farmergreg/vim-lastplace'

		" Snippet engine
		Plug 'SirVer/ultisnips'

		" Emmet
		Plug 'mattn/emmet-vim'

		" Linting
		Plug 'w0rp/ale'

		Plug 'tpope/vim-ragtag'

		Plug 'neoclide/coc.nvim', { 'branch': 'release' }

		" Switch between single line and multi line statemnts
		Plug 'AndrewRadev/splitjoin.vim'

		" Spelling and grammar checking
		Plug 'rhysd/vim-grammarous'

		Plug 'airblade/vim-accent'

		"
		" Inconvinience
		"

		Plug 'takac/vim-hardtime'

		"
		" Appearance
		"

		" Status bar
		Plug 'vim-airline/vim-airline'

		" Colourscheme
		Plug 'Iambecomeroot/wal.vim'

		" File icons
		Plug 'ryanoasis/vim-devicons'

		" Indent guides
		Plug 'Yggdroot/indentLine'

		" Automatically remove search highlighting
		Plug 'haya14busa/incsearch.vim'

		Plug 'chrisbra/Colorizer'

		" Colour manipulation
		Plug 'romgrk/lib.kom'

		" Syntax plugins
		Plug 'pangloss/vim-javascript'
		Plug 'Galooshi/vim-import-js'

		Plug 'mxw/vim-jsx'
		Plug 'mustache/vim-mustache-handlebars'
		Plug 'digitaltoad/vim-pug'
		Plug 'elzr/vim-json'
		Plug 'plasticboy/vim-markdown'
		Plug 'heavenshell/vim-jsdoc'
		Plug 'lervag/vimtex'
		" Plug 'python-mode/python-mode', { 'branch': 'develop' }
		Plug 'statico/vim-javascript-sql'
		Plug 'Vimjas/vim-python-pep8-indent'
		Plug 'jpalardy/vim-slime'
		Plug 'hanschen/vim-ipython-cell', { 'for': 'python' }
		" Plug 'hdima/python-syntax'
		" Plug 'Rykka/riv.vim'
		" Plug 'nvie/vim-flake8'
		Plug 'Matt-Deacalion/vim-systemd-syntax', { 'for': 'systemd' }
		Plug 'junegunn/goyo.vim', { 'for': 'markdown' }
		Plug 'shohei/vim-eagle-ulp'

	call plug#end()
endif

let g:riv_python_rst_hl=1


"
" General settings
"

" Use space as leader
let mapleader = " "

" Scroll with mousewheel
set mouse=a

filetype plugin indent on

" Use global swap file
" Then use `vim -L` for list of open files
let s:vim_swap_dir = s:vim_config_dir . 'swap'
if !isdirectory(s:vim_swap_dir)
	call mkdir(s:vim_swap_dir, "p")
endif
execute "set directory=" . s:vim_swap_dir

" Maintain undo history between sessions
let s:vim_undo_dir = s:vim_config_dir . 'undodir'
if !isdirectory(s:vim_undo_dir)
	call mkdir(s:vim_undo_dir, "p")
endif
set undofile
execute "set undodir=" . s:vim_undo_dir

" Open new splits on right
set splitright


"
" Appearance
"

set fileformats=unix

" Syntax highlighting
syntax on

" Start scrolling 10 lines before the horizontal window border
set scrolloff=10

" Break on words not on characters
set formatoptions=l
set linebreak

" Show (certain) invisibles
set list
set listchars=trail:·,tab:\│\ ,

" Indentation
set tabstop=2 softtabstop=2 shiftwidth=2 smarttab
set autoindent
set copyindent
set preserveindent

" Indent with tabs, align with spaces
" I am agaisnt lining up code as this creates unecessary changes when diffing,
" but it is needed for comment blocks with a single leading space
" set cindent
" set cinoptions=(0,u0,U0
set cinoptions=l1

autocmd Filetype python setlocal tabstop=4 softtabstop=4 shiftwidth=4 expandtab

" Line numbers
set number
set relativenumber

" Encoding and font
set encoding=utf-8
set guifont=Source\ Code\ Pro\ 12

map <F10> :echo "hi<" . synIDattr(synID(line("."),col("."),1),"name") . '> trans<'
\ . synIDattr(synID(line("."),col("."),0),"name") . "> lo<"
\ . synIDattr(synIDtrans(synID(line("."),col("."),1)),"name") . ">"<CR>

let g:vim_markdown_conceal = 0

" Show trailing whitespace
match Todo /\s\+$/

" No folding
set nofoldenable


"
" Buffers
"

" Allow buffers in background
set hidden

" Go to nth buffer
let c = 1
while c <= 999
	execute "nnoremap " . c . "<leader> :" . c . "b\<CR>"
	let c += 1
endwhile

" Automatically update files
set autoread

" Disable syntax highlighting for large files
autocmd BufWinEnter * if line2byte(line("$") + 1) > 1000000 | syntax clear | endif

function! RepeatChar(char, count)
	return repeat(a:char, a:count)
endfunction


nnoremap s :<C-U>exec "normal i".RepeatChar(nr2char(getchar()), v:count1)<CR>
nnoremap S :<C-U>exec "normal a".RepeatChar(nr2char(getchar()), v:count1)<CR>

" Continue comments on next line when max length is reached
set textwidth=79

augroup textwidth_autogroup
	autocmd FileType markdown setlocal textwidth=0
augroup END

if executable('par')
	set equalprg=par
endif
set formatoptions+=c


"
" Spelling
"

augroup spelling
	autocmd FileType markdown,gitcommit setlocal spell
	autocmd FileType gitcommit setlocal spelllang=en
augroup END

" Autocomplete words when spell is set
set complete+=kspell

let g:javascript_plugin_jsdoc = 1
" Supposed to make leaving insert mode faster
set ttimeoutlen=50

" Always show status line
set laststatus=2

" Hide default status bar
set shortmess+=F

" Colourscheme settings
silent! colorscheme wal

" Don't remove quotes from json
let g:vim_json_syntax_conceal = 0

let g:NERDSpaceDelims = 1

set conceallevel=0


"
" Project-specific settings
"

" Use French language in PFE report
autocmd BufEnter */rapport-final/**/* set spell spelllang=fr spellfile=fr.utf-8.add

" Use Italian language and spellfile for Italian notes
autocmd BufEnter /home/marcel/Nextcloud/Italian/**/* set spell spelllang=it spellfile=it.utf-8.add

" Set wrap in vimdiff
autocmd FilterWritePre * if &diff | setlocal wrap< | endif

function WriteOrphanedFile()
	silent call mkdir(expand('%:p:h'), 'p')
	w
endfunction

" Transparent editing of gpg encrypted files.
augroup encrypted
au!
" First make sure nothing is written to ~/.viminfo while editing
" an encrypted file.
autocmd BufReadPre,FileReadPre      *.gpg set viminfo=
" We don't want a swap file, as it writes unencrypted data to disk
autocmd BufReadPre,FileReadPre      *.gpg set noswapfile
" Switch to binary mode to read the encrypted file
autocmd BufReadPre,FileReadPre      *.gpg set bin
autocmd BufReadPre,FileReadPre      *.gpg let ch_save = &ch|set ch=2
autocmd BufReadPre,FileReadPre      *.gpg let shsave=&sh
autocmd BufReadPre,FileReadPre      *.gpg let &sh='sh'
autocmd BufReadPre,FileReadPre      *.gpg let ch_save = &ch|set ch=2
autocmd BufReadPost,FileReadPost    *.gpg '[,']!gpg --decrypt --default-recipient-self 2> /dev/null
autocmd BufReadPost,FileReadPost    *.gpg let &sh=shsave
" Switch to normal mode for editing
autocmd BufReadPost,FileReadPost    *.gpg set nobin
autocmd BufReadPost,FileReadPost    *.gpg let &ch = ch_save|unlet ch_save
autocmd BufReadPost,FileReadPost    *.gpg execute ":doautocmd BufReadPost " . expand("%:r")
" Convert all text to encrypted text before writing
autocmd BufWritePre,FileWritePre    *.gpg set bin
autocmd BufWritePre,FileWritePre    *.gpg let shsave=&sh
autocmd BufWritePre,FileWritePre    *.gpg let &sh='sh'
autocmd BufWritePre,FileWritePre    *.gpg '[,']!gpg --encrypt --default-recipient-self 2>/dev/null
autocmd BufWritePre,FileWritePre    *.gpg let &sh=shsave
" Undo the encryption so we are back in the normal text, directly
" after the file has been written.
autocmd BufWritePost,FileWritePost  *.gpg silent u
autocmd BufWritePost,FileWritePost  *.gpg set nobin
augroup END

function Grip()
	! grip $(get-open-port.sh) --browser > grip.log 2>&1 &
endfunction
command! Grip call Grip()
