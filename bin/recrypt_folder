#!/bin/bash

set -e

# Prevent `not a typewriter` errors
export GPG_TTY=$(tty)

filename="$(realpath $1)"

# Android doesn't have `/tmp`. Use `$HOME` instead
tmp=$([ -d /tmp ] && echo "/tmp" || echo "$HOME")

if [ -z "$filename" ]; then
	echo "Please give an encrypted archive to update."
	exit 1
fi

if [[ ! "$(file -b $filename)" =~ "PGP RSA encrypted session key"* ]]; then
	echo "$filename is not an encrypted archive."
	exit 1
fi

tmpdir="$(find "$tmp/gpgtar" -regex ".*\/$(basename $filename | cut -f 1 -d '.')_[0-9]_" | sort | tail -n1)"

gpgtar --encrypt --output "$filename" --recipient marcelrobitaille11@gmail.com -C "$tmpdir" .

rm -rf "$tmpdir"

cd - > /dev/null
