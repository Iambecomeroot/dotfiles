#!/usr/sbin/python

from mpd import MPDClient
import os
import subprocess
import sys

client = MPDClient()
client.timeout = 10
client.idleTimeout = None
client.connect('localhost', 6600)

current = '/home/marcel/Music/{}'.format(client.currentsong()['file'])
base = os.path.basename(current)
dirname = os.path.dirname(current)
cover = '{}/cover.jpg'.format(dirname)

client.close()
client.disconnect()

png = cover.replace('jpg', 'png')
if os.path.isfile(png):
    print(png)
    sys.exit(0)

if not os.path.isfile(cover):
    command = [
        '/usr/sbin/ffmpeg',
        '-i', current,
        cover
    ]
    process = subprocess.Popen(command, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
    out, err = process.communicate()
    errcode = process.returncode

    if err:
        print(err)
        sys.exit(1)

link = '/home/marcel/.config/mpd/covers/{}.jpg'.format(base)
if not os.path.isfile(link):
    os.symlink(cover, link)

print(link)
